name: ðŸš€ Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        game: [snake-game, tetris-game, flappy-bird, 2048-game, maze-game, jump-game, airplane-game, whack-mole, speed-tetris, tic-tac-toe-game, gomoku-game, sliding-puzzle-game, jigsaw-puzzle-game, memory-card-game, reaction-test-game, color-difference-game, parkour-game, fruit-hero-game, shadow-run-game, ball-dodger-game, geometry-dash-game, racing-game, stickman-fight-game, rhythm-game, typing-game, space-shooter-game, tower-defense-game, bubble-pop-game, rock-paper-scissors-game, emoji-match-game, math-challenge-game, flappy-parkour-game, rhythm-tap-game, typing-master-game]
        node-version: [18.x]
      max-parallel: 6
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '${{ matrix.game }}/package.json'
      
      - name: ðŸ“š Install dependencies
        working-directory: ${{ matrix.game }}
        run: npm install
      
      - name: ðŸ—ï¸ Build project
        working-directory: ${{ matrix.game }}
        run: npm run build
      
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.game }}-dist
          path: ${{ matrix.game }}/dist
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: ðŸ“ Create deployment directory
        run: |
          mkdir -p deploy
          cp index.html deploy/
          
          # å®šä¹‰æ‰€æœ‰æ¸¸æˆåˆ—è¡¨
          GAMES=(
            "snake-game" "tetris-game" "flappy-bird" "2048-game" "maze-game"
            "jump-game" "airplane-game" "whack-mole" "speed-tetris" "tic-tac-toe-game"
            "gomoku-game" "sliding-puzzle-game" "jigsaw-puzzle-game" "memory-card-game"
            "reaction-test-game" "color-difference-game" "parkour-game" "fruit-hero-game"
            "shadow-run-game" "ball-dodger-game" "geometry-dash-game" "racing-game"
            "stickman-fight-game" "rhythm-game" "typing-game" "space-shooter-game"
            "tower-defense-game" "bubble-pop-game" "rock-paper-scissors-game"
            "emoji-match-game" "math-challenge-game" "flappy-parkour-game"
            "rhythm-tap-game" "typing-master-game"
          )
          
          # å¤åˆ¶æ‰€æœ‰æ¸¸æˆçš„æž„å»ºäº§ç‰©
          for game in "${GAMES[@]}"; do
            if [ -d "artifacts/${game}-dist" ]; then
              cp -r "artifacts/${game}-dist" "deploy/${game}"
            fi
          done
          
          echo "âœ… éƒ¨ç½²ç›®å½•å·²å‡†å¤‡å®Œæ¯•"
          ls -la deploy/ | head -20
      
      - name: ðŸ”§ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'deploy'
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: ðŸ“ Create deployment summary
        run: |
          echo "## ðŸŽ® GitHub Pages Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
